library(DBI)
library(RPostgres)
library(sf)
library(ggplot2)
library(tmap)
tmap_mode("view")
library(dplyr)
library(gganimate)




###############################
# Etape 1 : Connexion à la BDD
###############################
bdd <- dbConnect(
  RPostgres::Postgres(),
  dbname = "DM",
  host = "localhost", # ou l'adresse du serveur
  port = 5432, # port par défaut PostgreSQL
  user = "postgres",
  password = "postgres"
)

# Vérifier la connexion
dbListTables(bdd)


###############################
# Etape 2 : Importer les données
###############################

theatre <- st_read(
  dsn = bdd,
  query = "SELECT id_t, nom_t, geom FROM THEATRE"
)


# Charger la vue matérialisée : id_theatre, date_lst, temp
tls <- dbGetQuery(bdd, "
    SELECT id_theatre, date_lst, temp
    FROM THEATRE_LST_SERIE
    ORDER BY id_theatre, date_lst
")

lst <- 

###############################
# Etape 3 : Visualiser les théâtres 
###############################

tm_shape(theatre) +
  tm_dots(col = "blue", size = 0.5) +
  tm_text("nom_t", size = 0.7)


###############################
# Etape 4 : Supprimer les valeurs aberrantes 
###############################

ab_neg <- quantile(tls$temp, 0.25)- 1.5* IQR(tls$temp)

tls <- tls %>% filter(temp>ab_neg)


###############################
# Etape 4 : Graphiques température
###############################

# 1. Ajouter les noms des théâtres
tls2 <- tls %>%
  left_join(theatre %>% st_drop_geometry(), 
            by = c("id_theatre" = "id_t"))

# 2. Calculer la température moyenne par théâtre
moyennes <- tls2 %>%
  group_by(nom_t) %>%
  summarise(temp_moy = mean(temp, na.rm = TRUE)) %>%
  arrange(desc(temp_moy))

# 3. Réordonner les théâtres selon la température moyenne
tls2$nom_t <- factor(tls2$nom_t, levels = moyennes$nom_t)

# 4. Construire le sous-titre dynamique
sous_titre <- paste(
  "Température moyenne par théâtre (ordre décroissant) :",
  paste0(moyennes$nom_t, " = ", round(moyennes$temp_moy, 1), "°C", collapse = " | ")
)


# 5. Ajouter la température moyenne pour chaque théâtre
tls2 <- tls2 %>%
  left_join(moyennes, by = "nom_t") %>%
  mutate(
    nom_t = factor(nom_t, levels = moyennes$nom_t), # ordre décroissant
    sous_titre_facet = paste0("Temp moyenne = ", round(temp_moy, 1), "°C")
  )

# 6. Créer un vecteur de labeller pour chaque niveau
labeller_vect <- setNames(tls2$sous_titre_facet, tls2$nom_t)

# 7. Graphique avec facettes et sous-titre par facette
p <- ggplot(tls2, aes(x = date_lst, y = temp)) +
  geom_line(color = "steelblue", linewidth = 0.6) +
  geom_hline(yintercept = 36, color = "red" ) +
  facet_wrap(~ nom_t, scales = "free_y",
             labeller = labeller(nom_t = function(x) {
               paste0(x, "\n", labeller_vect[as.character(x)])
             })) +
  theme_minimal() +
  labs(
    title = "Évolution de la température LST par théâtre",
    x = "Année",
    y = "Température (LST)"
  )

p


# 8. Export PDF sur deux pages
ggsave("output/theatre_LST_graphs.pdf", p, width = 14, height = 10)


# ---------------------------------------------------------------#

# 1. Ajouter les noms des théâtres
tls2 <- tls %>%
  left_join(theatre %>% st_drop_geometry(), 
            by = c("id_theatre" = "id_t"))

# 2. Calculer la température moyenne par théâtre
moyennes <- tls2 %>%
  group_by(nom_t) %>%
  summarise(temp_moy = mean(temp, na.rm = TRUE)) %>%
  arrange(desc(temp_moy))

# 3. Ajouter temp_moy à tls2
tls2 <- tls2 %>%
  left_join(moyennes, by = "nom_t") %>%
  mutate(
    nom_t = factor(nom_t, levels = moyennes$nom_t),
    sous_titre_facet = paste0("Temp moyenne = ", round(temp_moy, 1), "°C")
  )



# Créer un vecteur de labeller
labeller_vect <- setNames(tls2$sous_titre_facet, tls2$nom_t)

# Graphique animé
p_anim <- ggplot(tls2, aes(x = date_lst, y = temp, group = nom_t)) +
  geom_line(color = "steelblue", linewidth = 0.6) +
  facet_wrap(~ nom_t, scales = "free_y",
             labeller = labeller(nom_t = function(x) {
               paste0(x, "\n", labeller_vect[as.character(x)])
             })) +
  labs(
    title = "Évolution de la température LST par théâtre",
    x = "Année",
    y = "Température (LST)"
  ) +
  theme_minimal() +
  transition_reveal(date_lst) # anime la ligne au fil du temps

# Exporter le GIF
anim_save("output/theatre_temperatures.gif", p_anim, width = 800, height = 600)
